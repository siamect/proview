/*
 * ProviewR   Open Source Process Control.
 * Copyright (C) 2005-2021 SSAB EMEA AB.
 *
 * This file is part of ProviewR.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProviewR. If not, see <http://www.gnu.org/licenses/>
 *
 * Linking ProviewR statically or dynamically with other modules is
 * making a combined work based on ProviewR. Thus, the terms and
 * conditions of the GNU General Public License cover the whole
 * combination.
 *
 * In addition, as a special exception, the copyright holders of
 * ProviewR give you permission to, from the build function in the
 * ProviewR Configurator, combine ProviewR with modules generated by the
 * ProviewR PLC Editor to a PLC program, regardless of the license
 * terms of these modules. You may copy and distribute the resulting
 * combined work under the terms of your choice, provided that every
 * copy of the combined work is accompanied by a complete copy of
 * the source code of ProviewR (the version used to produce the
 * combined work), being distributed under the terms of the GNU
 * General Public License plus this exception.
 **/

/* wb_dir.c -- Directory information
   This module returns information about directory and files.  */

#include <stdlib.h>
#include <sys/stat.h>

#include "co_dcli.h"
#include "co_string.h"
#include "co_time.h"

#include "wb_dir.h"

/*************************************************************************
*
* Name:		dir_parse_filename
*
* Type		int
*
* Description:
*	Parses a filename in device, directory, namn, type and version.
*
* Parameters
*	filename	*char	I  Filenamn that will be parsed.
*	dev		*char	O  device.
*	dir		*char	O  directory.
*	file		*char	O  filenamn.
*	type		*char	O  type.
*	version		*int	O  version.
*
**************************************************************************/

pwr_tStatus dir_parse_filename(
    char* filename, char* dev, char* dir, char* file, char* type, int* version)
{
  char *s, *t;
  char ldev[200];
  char ldir[200];
  char lfile[200];
  char ltype[80];
  char lversion[80];
  int sts;

  if ((s = strstr(filename, "::")))
    s += 2;
  else
    s = filename;
  strcpy(ldev, s);

  /* Device */
  if ((s = strchr(ldev, ':')))
    s++;
  else
    s = ldev;
  strcpy(ldir, s);
  *s = 0;

  /* Directory */
  if ((s = strchr(ldir, '>')))
    s++;
  else {
    if ((s = strchr(ldir, ']')))
      s++;
    else
      s = ldir;
  }
  strcpy(lfile, s);
  *s = 0;

  /* File */
  if ((s = strchr(lfile, '.')) == 0)
    s = lfile;
  strcpy(ltype, s);
  *s = 0;

  /* Type */
  if ((s = strchr(ltype, ';')))
    t = s++;
  else {
    if ((s = strchr(ltype + 1, '.')))
      t = s++;
    else {
      s = ltype;
      t = s + strlen(s);
    }
  }
  strcpy(lversion, t);
  *t = 0;

  if (streq(lversion, "")) {
    *version = 0;
  } else {
    sts = sscanf(lversion, "%d", version);
    if (sts != 1)
      *version = 0;
  }

  strcpy(dev, ldev);
  strcpy(dir, ldir);
  strcpy(file, lfile);
  strcpy(type, ltype);
  return 1;
}

/****************************************************************************
* Name:		dir_get_fileinfo ()
*
* Type		int
*
* Type		Parameter	IOGF	Description
*
* Description:
* 	Send back creation time and size of a given file
*
**************************************************************************/
pwr_tStatus dir_get_fileinfo(char* file_name, pwr_tTime* time2_ptr, int* size_p,
    int* vmsvers_p, char* found_file)
{
  struct stat info;
  int sts;
  char fname[200];

  dcli_translate_filename(fname, file_name);
  sts = stat(fname, &info);
  if (sts == -1)
    return 0;

  if (time2_ptr) {
    time2_ptr->tv_sec = info.st_ctime;
    time2_ptr->tv_nsec = 0;
  }
  if (size_p)
    *size_p = (int)info.st_size;
  if (vmsvers_p)
    *vmsvers_p = 0;
  if (found_file != NULL)
    strcpy(found_file, file_name);

  return 1;
}

/*************************************************************************
*
* Name:		dir_TimeString
*
* Type		*char
*
* Description:
*		Converts a VMS-time to a string.
*
* Parameters
*
**************************************************************************/

char* dir_TimeString(pwr_tTime* time, char* timestr)
{
  static char timstr[32];

  time_AtoAscii(time, time_eFormat_DateAndTime, timstr, sizeof(timstr));
  if (timestr != NULL)
    strcpy(timestr, &timstr[5]);

  return timstr;
}

/*************************************************************************
*
* Name:		dir_CopyFile
*
* Type		pwr_tStatus
*
* Description:
*		Copy a file.
*
* Parameters
*
**************************************************************************/
pwr_tStatus dir_CopyFile(char* from, char* to)
{
  int sts;
  static char cmd[100];
#ifdef OS_LINUX
  sprintf(cmd, "cp %s %s", from, to);
#endif
  sts = system(cmd);

  return sts;
}

/*************************************************************************
*
* Name:		dir_PurgeFile
*
* Type		pwr_tStatus
*
* Description:
*		Purge a file.
*
* Parameters
*
**************************************************************************/
pwr_tStatus dir_PurgeFile(char* filename, int keep)
{
  return 1;
}

/*************************************************************************
*
* Name:		dir_DeleteFile
*
* Type		pwr_tStatus
*
* Description:
*		Delete a file.
*
* Parameters
*
**************************************************************************/
pwr_tStatus dir_DeleteFile(char* filename)
{
  int sts;
  static char cmd[100];
#ifdef OS_LINUX
  sprintf(cmd, "rm %s", filename);
#endif
  sts = system(cmd);

  return sts;
}

/*************************************************************************
*
* Name:		dir_DefineLogical
*
* Type		pwr_tStatus
*
* Description:
*		Define a logical name.
*
* Parameters
*
**************************************************************************/
pwr_tStatus dir_DefineLogical(char* name, char* value, char* table)
{
  printf("DefineLogical: NYI\n");
  return 0;
}
/*************************************************************************
*
* Name:		dir_DeassignLogical
*
* Type		pwr_tStatus
*
* Description:
*		Deassign a logical name.
*
* Parameters
*
**************************************************************************/
pwr_tStatus dir_DeassignLogical(char* name, char* table)
{
  printf("DeassignLogical: NYI\n");
  return 0;
}

#ifdef RMS_TEST
main()
{
  int sts;
  long date2[2];
  char wild_filename[80] = "t*.t";
  char filename[80];
  char dev[80];
  char dir[80];
  char file[80];
  char type[80];
  int version;

  sts = dir_search_file(wild_filename, filename, 1, 0);
  if (EVEN(sts))
    printf("No files\n");
  printf("%s\n", filename);

  sts = dir_parse_filename(filename, dev, dir, file, type, &version);

  while (ODD(sts)) {
    sts = dir_search_file(wild_filename, filename, 0, 0);
    if (ODD(sts))
      printf("%s\n", filename);
  }
}
#endif
