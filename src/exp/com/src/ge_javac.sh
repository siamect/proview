#!/bin/bash
#
# ProviewR   Open Source Process Control.
# Copyright (C) 2005-2021 SSAB EMEA AB.
#
# This file is part of ProviewR.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 2 of
# the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ProviewR. If not, see <http://www.gnu.org/licenses/>
#
# Linking ProviewR statically or dynamically with other modules is
# making a combined work based on ProviewR. Thus, the terms and
# conditions of the GNU General Public License cover the whole
# combination.
#
# In addition, as a special exception, the copyright holders of
# ProviewR give you permission to, from the build function in the
# ProviewR Configurator, combine ProviewR with modules generated by the
# ProviewR PLC Editor to a PLC program, regardless of the license
# terms of these modules. You may copy and distribute the resulting
# combined work under the terms of your choice, provided that every
# copy of the combined work is accompanied by a complete copy of
# the source code of ProviewR (the version used to produce the
# combined work), being distributed under the terms of the GNU
# General Public License plus this exception.
#
#
#
function=$1
src_file=$2
systemname=$3
signature=$4


if [ $function == "java_web" ]; then
  jarfile="$pwrp_web/pwrp_"$systemname"_web.jar"

  if javac -d $pwrp_web -classpath $pwr_lib/pwr_rt.jar:$pwr_lib/pwr_jop.jar:$pwr_lib/pwr_jopc.jar:$jarfile $pwrp_pop/$src_file
  then
    echo "-- $src_file compiled"
    if [ ! -e $jarfile ]; then
      cd $pwrp_web
      jar -cf $jarfile ${src_file%.java}.class
      rm ${src_file%.java}.class
    else
      cd $pwrp_web
      jar -uf $jarfile ${src_file%.java}.class
      rm ${src_file%.java}.class
    fi
    files=`ls $pwrp_web/${src_file%.java}\\$*.class 2>&-`
    if [ ! -z "$files" ]; then
      # echo "Insert in archive $jarfile"
      jar -uf $jarfile ${src_file%.java}\$*.class
      rm ${src_file%.java}\$*.class
    fi
    files=`ls $pwrp_pop/*.gif 2>&-`
    if [ ! -z "$files" ]; then
      cd $pwrp_pop
      jar -uf $jarfile *.gif
    fi
    files=`ls $pwrp_pop/*.jpg 2>&-`
    if [ ! -z "$files" ]; then
      cd $pwrp_pop
      jar -uf $jarfile *.jpg
    fi

    if [ "$signature" != "" ]; then
      storepass=${signature#*/}
      passopt=""
      if [ "$storepass" != "$signature" ]; then
        signature=${signature%/*}
	passopt="-storepass "$storepass
      fi

      jars=`eval ls $pwrp_web/*.jar`

      for jarfile in $jars; do
	ok="jar verified."
	res=`eval jarsigner -verify $jarfile $signature`
	if [ "$res" != "$ok" ]; then
	  echo "-- Signature $signature set to $jarfile"
	  jarsigner $passopt $jarfile $signature
	fi
      done
    fi
  fi
fi

if [ $function == "java" ]; then
  jarfile="$pwrp_lib/pwrp_"$systemname".jar"
  jarfileweb="$pwrp_web/pwrp_"$systemname"_web.jar"

  if javac -d $pwrp_web -classpath $pwr_lib/pwr_rt.jar:$pwr_lib/pwr_jop.jar:$pwr_lib/pwr_jopc.jar:$jarfile $pwrp_pop/$src_file
  then
    echo "-- $src_file compiled"
    if [ ! -e $jarfile ]; then
      cd $pwrp_web
      jar -cf $jarfile ${src_file%.java}.class
    else
      cd $pwrp_web
      jar -uf $jarfile ${src_file%.java}.class
    fi
    if [ ! -e $jarfileweb ]; then
      cd $pwrp_web
      jar -cf $jarfileweb ${src_file%.java}.class
    else
      cd $pwrp_web
      jar -uf $jarfileweb ${src_file%.java}.class
    fi
    rm ${src_file%.java}.class
    files=`ls $pwrp_web/${src_file%.java}\\$*.class 2>&-`
    if [ ! -z "$files" ]; then
      # echo "Insert in archive $jarfile"
      jar -uf $jarfile ${src_file%.java}\$*.class
      jar -uf $jarfileweb ${src_file%.java}\$*.class
      rm ${src_file%.java}\$*.class
    fi
    files=`ls $pwrp_pop/*.gif 2>&-`
    if [ ! -z "$files" ]; then
      cd $pwrp_pop
      jar -uf $jarfile *.gif
      jar -uf $jarfileweb *.gif
    fi
    files=`ls $pwrp_pop/*.jpg 2>&-`
    if [ ! -z "$files" ]; then
      cd $pwrp_pop
      jar -uf $jarfile *.jpg
      jar -uf $jarfileweb *.jpg
    fi
    if [ "$signature" != "" ]; then
      storepass=${signature#*/}
      passopt=""
      if [ "$storepass" != "$signature" ]; then
        signature=${signature%/*}
	passopt="-storepass "$storepass
      fi

      jars=`eval ls $pwrp_web/*.jar`

      for jarfile in $jars; do
	ok="jar verified."
	res=`eval jarsigner -verify $jarfile $signature`
	if [ "$res" != "$ok" ]; then
	  echo "-- Signature $signature set to $jarfile"
	  jarsigner $passopt $jarfile $signature
	fi
      done
    fi
  fi
fi

if [ $function == "html" ]; then
  cp $pwrp_pop/$src_file $pwrp_web/
fi
