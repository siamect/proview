#!/bin/bash
#
# ProviewR   Open Source Process Control.
# Copyright (C) 2005-2021 SSAB EMEA AB.
#
# This file is part of ProviewR.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 2 of
# the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ProviewR. If not, see <http://www.gnu.org/licenses/>
#
# Linking ProviewR statically or dynamically with other modules is
# making a combined work based on ProviewR. Thus, the terms and
# conditions of the GNU General Public License cover the whole
# combination.
#
# In addition, as a special exception, the copyright holders of
# ProviewR give you permission to, from the build function in the
# ProviewR Configurator, combine ProviewR with modules generated by the
# ProviewR PLC Editor to a PLC program, regardless of the license
# terms of these modules. You may copy and distribute the resulting
# combined work under the terms of your choice, provided that every
# copy of the combined work is accompanied by a complete copy of
# the source code of ProviewR (the version used to produce the
# combined work), being distributed under the terms of the GNU
# General Public License plus this exception.
#
#
# Compile a rtt picture
#
# set -o xtrace

name=$1
pgmname=$2
is_rttsys=$3
opsys=$4

if [ "$pwre_cc" != "" ]; then
  cc=$pwre_cc
else
  cc=gcc
fi

if [ $opsys = "64" ] || [ $opsys = "128" ]; then
  cflags="${cross_compile} -DOS_LINUX -DOS=linux -DHW_X86=1 -DPOSIX_SOURCE -DWall"
fi
if [ $opsys = "256" ]; then
  cflags="${cross_compile} -DOS_MACOS -DOS=macos -DHW_X86_64=1 -DPOSIX_SOURCE -DWall"
fi
if [ $opsys = "512" ]; then
  cflags="${cross_compile} -DOS_LINUX -DOS=linux -DHW_ARM=1 -DPOSIX_SOURCE -DWall"
fi
if [ $opsys = "1024" ]; then
  cflags="${cross_compile} -DOS_FREEBSD -DOS=freebsd -DHW_X86_64=1 -DPOSIX_SOURCE -DWall"
fi
if [ $opsys = "2048" ]; then
  cflags="${cross_compile} -DOS_OPENBSD -DOS=openbsd -DHW_X86_64=1 -DPOSIX_SOURCE -DWall"
fi
if [ $opsys = "4096" ]; then
  cflags="${cross_compile} -DOS_CYGWIN -DOS=cygwin -DHW_X86=1 -DPOSIX_SOURCE -DWall"
fi

if [ $is_rttsys = "0" ]; then
  ar_name_pict=${pwrp_lib}/ra_rtt_${pgmname}_pict.a

  cinc="-I$pwr_inc -I$pwrp_rttbld"
  ${cc} -c -o $pwrp_obj/${name}.o $pwrp_rttbld/${name}.c ${cinc} ${cflags}
  ar rcU ${ar_name_pict} $pwrp_obj/${name}.o
else
  ar_name_pict=${pwr_lib}/libpwr_dtt.a
  bld_dir=$pwre_broot/$pwre_os/$pwre_hw/bld/lib/dtt

  cinc="-I$pwr_inc -I${bld_dir}"
  ${cc} -c -o ${bld_dir}/${name}.o \
     ${bld_dir}/${name}.c ${cinc} ${cflags}
  ar rcU ${ar_name_pict} ${bld_dir}/${name}.o
fi
