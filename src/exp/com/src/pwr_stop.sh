#!/bin/bash
#
# ProviewR   Open Source Process Control.
# Copyright (C) 2005-2021 SSAB EMEA AB.
#
# This file is part of ProviewR.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 2 of
# the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ProviewR. If not, see <http://www.gnu.org/licenses/>
#
# Linking ProviewR statically or dynamically with other modules is
# making a combined work based on ProviewR. Thus, the terms and
# conditions of the GNU General Public License cover the whole
# combination.
#
# In addition, as a special exception, the copyright holders of
# ProviewR give you permission to, from the build function in the
# ProviewR Configurator, combine ProviewR with modules generated by the
# ProviewR PLC Editor to a PLC program, regardless of the license
# terms of these modules. You may copy and distribute the resulting
# combined work under the terms of your choice, provided that every
# copy of the combined work is accompanied by a complete copy of
# the source code of ProviewR (the version used to produce the
# combined work), being distributed under the terms of the GNU
# General Public License plus this exception.
#

  pkill "rt_neth_acp"
  pkill "rt_neth"
  pkill "rt_qmon"
  pkill "rt_emon"
  pkill "rt_tmon"
  pkill "^rt_"
  pkill "/pwr/exe/rs"
  pkill "\[rt_"
  pkill "^plc_"
  pkill "jpwr.rt"
  pkill "rs_nmps"
  pkill "rs_remote"
  pkill "sev_server"
  pkill "opc_server"
  pkill "opc_provider"
  if [ -u $pwr_exe/rt_ini ]; then
    user=`ls -al $pwr_exe/rt_ini | awk '{ print $3}'`
  else
    user=$USER
  fi

  echo "User $user"

  eval `ipcs -s|grep ^0x|grep "[ \t]$user[ \t]"|awk '{printf "ipcrm sem %s;", $2
}'`

# remove message queues
  eval `ipcs -q|grep ^0x|grep "[ \t]$user[ \t]"|awk '{printf "ipcrm msg %s;", $2
}'`

# remove shared memory
  eval `ipcs -m|grep ^0x|grep "[ \t]$user[ \t]"|awk '{printf "ipcrm shm %s;", $2
}'`

  node=`eval uname -n`
  applfile=$pwrp_load"/ld_appl_"$node"_"$PWR_BUS_ID".txt"

  if [ -e $applfile ]; then
    stored_ifs=$IFS
    IFS=' ,'
    while read appid appname appload apprun appfile appprio appdebug apparg; do
      s1=`eval 'echo $appid' | head -c1`
      s8=`eval 'echo $appid' | head -c8`
      if [ -n "$appid" ] && [ "$s1" != "#" ]; then
        if [ $appid != "pwr_neth" ] &&
           [ $appid != "pwr_qmon" ] &&
           [ $appid != "pwr_nacp" ] &&
           [ $appid != "pwr_io" ] &&
           [ $appid != "pwr_tmon" ] &&
           [ $appid != "pwr_emon" ] &&
           [ $appid != "pwr_alim" ] &&
           [ $appid != "pwr_bck" ] &&
           [ $appid != "pwr_linksup" ] &&
           [ $appid != "pwr_trend" ] &&
           [ $appid != "pwr_fast" ] &&
           [ $appid != "pwr_remh" ] &&
           [ $appid != "pwr_remlog" ] &&
           [ $appid != "pwr_elog" ] &&
           [ $appid != "pwr_sysmon" ] &&
           [ $appid != "pwr_webmon" ] &&
           [ $appid != "pwr_webmonmh" ] &&
           [ $appid != "pwr_webmonelog" ] &&
           [ $appid != "pwr_opc_server" ] &&
           [ $appid != "pwr_statussrv" ] &&
           [ $appid != "pwr_post" ] &&
           [ $appid != "pwr_report" ] &&
           [ $appid != "pwr_sevhistmon" ] &&
           [ $appid != "pwr_sev_server" ] &&
           [ $appid != "pwr_powerlink" ] &&
           [ $appid != "pwr_videomgm" ] &&
           [ $appid != "pwr_redcom" ] &&
           [ $appid != "pwr_sim" ] &&
           [ $appid != "pwr_plc" ] &&
           [ "$appfile" != "rt_io_comm" ] &&
           [ "$s8" != "pwr_plc_" ] &&
           [ "$applname" != "" ]; then
          killall $appname
        fi
      fi
    done < $applfile
    IFS=$stored_ifs
  fi

  if [ -e $pwrp_exe/pwrp_stop.sh ]; then
    source $pwrp_exe/pwrp_stop.sh
  fi

  rm -f /tmp/pwr*$PWR_BUS_ID

  #rm -f /tmp/pwr*
  #id=`ipcs -s | grep $user | awk '{print $2}'`
  #id1=`echo $id | awk '{print $1}'`
  #id2=`echo $id | awk '{print $2}'`
  #id3=`echo $id | awk '{print $3}'`
  #ipcrm sem $id1
  #ipcrm sem $id2
  #ipcrm sem $id3
  #id=`ipcs -q | grep $user | awk '{print $2}'`
  #id1=`echo $id | awk '{print $1}'`
  #id2=`echo $id | awk '{print $2}'`
  #id3=`echo $id | awk '{print $3}'`
  #ipcrm msg $id1
  #ipcrm msg $id2
  #ipcrm msg $id3
