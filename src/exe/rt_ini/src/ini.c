/*
 * ProviewR   Open Source Process Control.
 * Copyright (C) 2005-2021 SSAB EMEA AB.
 *
 * This file is part of ProviewR.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProviewR. If not, see <http://www.gnu.org/licenses/>
 *
 * Linking ProviewR statically or dynamically with other modules is
 * making a combined work based on ProviewR. Thus, the terms and
 * conditions of the GNU General Public License cover the whole
 * combination.
 *
 * In addition, as a special exception, the copyright holders of
 * ProviewR give you permission to, from the build function in the
 * ProviewR Configurator, combine ProviewR with modules generated by the
 * ProviewR PLC Editor to a PLC program, regardless of the license
 * terms of these modules. You may copy and distribute the resulting
 * combined work under the terms of your choice, provided that every
 * copy of the combined work is accompanied by a complete copy of
 * the source code of ProviewR (the version used to produce the
 * combined work), being distributed under the terms of the GNU
 * General Public License plus this exception.
 */

#include <ctype.h>

#include "pwr_baseclasses.h"
#include "pwr_remoteclasses.h"
#include "pwr_nmpsclasses.h"
#include "pwr_basecomponentclasses.h"
#include "pwr_otherioclasses.h"
#include "pwr_opcclasses.h"
#include "pwr_sevclasses.h"

#include "co_dcli.h"
#include "co_string.h"
#include "co_syi.h"

#include "rt_ini_event.h"
#include "rt_ini_alias.h"
#include "rt_ini_msg.h"
#include "rt_io_base.h"

#include "ini.h"

#define cPrio_base 0
#define cPrio_neth (cPrio_base + 18)
#define cPrio_qmon (cPrio_base + 19)
#define cPrio_neth_acp (cPrio_base + 17)
#define cPrio_io_comm (cPrio_base + 17)
#define cPrio_tmon (cPrio_base + 17)
#define cPrio_emon (cPrio_base + 17)
#define cPrio_alimserver (cPrio_base + 17)
#define cPrio_bck (cPrio_base + 16)
#define cPrio_linksup (cPrio_base + 16)
#define cPrio_fast (cPrio_base + 15)
#define cPrio_trend (cPrio_base + 15)
#define cPrio_webmon (cPrio_base + 15)
#define cPrio_webmonmh (cPrio_base + 15)
#define cPrio_webmonelog (cPrio_base + 15)
#define cPrio_websocketserver (cPrio_base + 15)
#define cPrio_elog (cPrio_base + 15)
#define cPrio_sysmon (cPrio_base + 16)
#define cPrio_opc_server (cPrio_base + 15)
#define cPrio_statussrv (cPrio_base + 15)
#define cPrio_post (cPrio_base + 5)
#define cPrio_report (cPrio_base + 5)
#define cPrio_sevhistmon (cPrio_base + 15)
#define cPrio_sev_server (cPrio_base + 15)
#define cPrio_sev_import (cPrio_base + 15)
#define cPrio_powerlink (cPrio_base + 15)
#define cPrio_plc_init (cPrio_base + 5)
#define cPrio_remh (cPrio_base + 5)
#define cPrio_remotelogg (cPrio_base + 5)
#define cPrio_sim (cPrio_base + 5)
#define cPrio_videomgm (cPrio_base + 5)
#define cPrio_redcom (cPrio_base + 17)

void ini_ProcTable(pwr_tStatus* status, ini_sContext* cp)
{
  FILE* f;
  pwr_sAppl* ap;
  pwr_tObjid oid;
  ini_sProc* pp;
  char* s;
  char buffer[256];
  pwr_tStatus lsts;
  int plc_idx;

  pwr_dStatus(sts, status, INI__SUCCESS);

  pp = ini_ProcInsert(sts, cp, "pwr_neth", "pwr_neth_%d", 0, 1, "rt_neth",
      cPrio_neth, 0, 0, "", 0);
  pp->flags.b.neth = 1;
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_qmon", "pwr_qmon_%d", 0, 1, "rt_qmon",
      cPrio_qmon, 0, 0, "", 0);
  pp->flags.b.qmon = 1;
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_nacp", "pwr_nacp_%d", 0, 1, "rt_neth_acp",
      cPrio_neth_acp, 0, 0, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_io", "pwr_io_%d", 0, 1, "rt_io_comm",
      cPrio_io_comm, 0, pwr_cClass_IOHandler, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_tmon", "pwr_tmon_%d", 0, 1, "rt_tmon",
      cPrio_tmon, 0, 0, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_emon", "pwr_emon_%d", 0, 1, "rt_emon",
      cPrio_emon, 0, 0, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_alim", "pwr_alim_%d", 0, 1, "rt_alimserver",
      cPrio_alimserver, 0, 0, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_bck", "pwr_bck_%d", 0, 1, "rt_bck",
      cPrio_bck, 0, pwr_cClass_Backup_Conf, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_linksup", "pwr_linksup_%d", 0, 1,
      "rt_linksup", cPrio_linksup, 0, pwr_cClass_NodeLinkSup, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_trend", "pwr_trend_%d", 0, 1, "rt_trend",
      cPrio_trend, 0, pwr_cClass_DsTrendConf, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_fast", "pwr_fast_%d", 0, 1, "rt_fast",
      cPrio_fast, 0, pwr_cClass_DsFastConf, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_remh", "pwr_remh_%d", 0, 1,
      "rs_remotehandler", cPrio_remh, 0, pwr_cClass_RemoteConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_remlog", "pwr_remlog_%d", 0, 1,
      "rs_remote_logg", cPrio_remotelogg, 0, pwr_cClass_LoggConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_elog", "pwr_elog_%d", 0, 1, "rt_elog",
      cPrio_elog, 0, 0, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_sysmon", "pwr_sysmon_%d", 0, 1, "rt_sysmon",
      cPrio_sysmon, 0, pwr_cClass_SysMonConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_webmon", "pwr_webmon_%d", 0, 1,
      "rt_webmon.sh", cPrio_webmon, 0, pwr_cClass_WebHandler, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_webmonmh", "pwr_webmonmh_%d", 0, 1,
      "rt_webmonmh.sh", cPrio_webmonmh, 0, pwr_cClass_WebHandler, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_webmonelog", "pwr_webmonelog_%d", 0, 1,
      "rt_webmonelog.sh", cPrio_webmonelog, 0, pwr_cClass_WebHandler, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_websocketserver", "pwr_websocketserver_%d", 0, 1,
      "rt_websocketserver.sh", cPrio_websocketserver, 0, pwr_cClass_WebSocketServer, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_opc_server", "pwr_opc_server_%d", 0, 1,
      "opc_server", cPrio_opc_server, 0, pwr_cClass_Opc_ServerConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_statussrv", "pwr_statussrv_%d", 0, 1,
      "rt_statussrv", cPrio_statussrv, 0, pwr_cClass_StatusServerConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_post", "pwr_post_%d", 0, 1, "rt_post",
      cPrio_post, 0, pwr_cClass_PostConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_report", "pwr_report_%d", 0, 1, "rt_report",
      cPrio_report, 0, pwr_cClass_ReportConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_sevhistmon", "pwr_sevhistmon_%d", 0, 1,
      "rt_sevhistmon", cPrio_sevhistmon, 0, pwr_cClass_SevHistMonitor, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_sev_server", "pwr_sev_server_%d", 0, 1,
      "sev_server", cPrio_sev_server, 0, pwr_cClass_SevServer, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_sev_import", "pwr_sev_import_%d", 0, 1,
      "sev_import", cPrio_sev_import, 0, pwr_cClass_SevImportServer, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_powerlink", "pwr_powerlink_%d", 0, 1,
      "rt_powerlink", cPrio_powerlink, 0, pwr_cClass_EplHandler, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_videomgm", "pwr_videomgm_%d", 0, 1,
      "rt_videomgm", cPrio_videomgm, 0, pwr_cClass_VideoMgmServer, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_redcom", "pwr_redcom_%d", 0, 1, "rt_redcom",
      cPrio_redcom, 0, pwr_cClass_RedcomConfig, "", 0);
  pp->proc.flags.b.system = 1;

  pp = ini_ProcInsert(sts, cp, "pwr_sim", "pwr_sim_%d", 0, 1, "rt_sim",
      cPrio_sim, 0, pwr_cClass_SimulateConfig, "", 0);
  pp->proc.flags.b.system = 1;

  if (!cp->plcfile_cnt) {
    plc_idx = 0;
    pp = ini_ProcInsert(sts, cp, "pwr_plc", "pwr_plc_%d", 0, 1, "rt_plc_core",
        cPrio_plc_init, 0, pwr_cClass_PlcProcess, "", 0);
    pp->flags.b.plc = 1;
    cp->plc = pp;
    pp->proc.flags.b.user = 1;
    pp->proc.flags.b.k_mode = 1;
    pp->proc.k_size = 30;
    cp->plc_sigmask |= ini_mEvent_plc1 << plc_idx;
    plc_idx++;
  } else {
    plc_idx = 0;
    cp->plc_sigmask = 0;
    for (lsts = gdh_GetClassList(pwr_cClass_PlcProcess, &oid); ODD(lsts);
         lsts = gdh_GetNextObject(oid, &oid)) {
      pwr_sClass_PlcProcess* plc;
      pwr_tObjName ppname;
      pwr_tObjName name;
      char p_name[80];
      int i;
      char busidstr[10];
      int found;
      char idstr[80];

      *sts = gdh_ObjidToName(oid, ppname, sizeof(ppname), cdh_mName_object);
      if (EVEN(*sts))
        break;

      *sts = gdh_ObjidToPointer(oid, (void*)&plc);
      if (EVEN(*sts))
        break;

      sprintf(busidstr, "_%04d_", cp->busid);

      found = 0;
      for (i = 0; i < cp->plcfile_cnt; i++) {
        s = strstr(cp->plcfile[i].name, busidstr);
        if (s) {
          strncpy(name, s + 6, sizeof(name));
          if ((s = strchr(name, '.')))
            *s = 0;

          if (str_NoCaseStrcmp(ppname, name) == 0) {
            found = 1;
            break;
          }
        }
      }

      if (!found) {
        plc_idx++;
        continue;
      }

      // cp->PlcProcess = plc;
      snprintf(idstr, sizeof(idstr), "pwr_plc_%s", name);
      snprintf(p_name, sizeof(p_name), "pwr_plc_%s_%%d_%d", name,
          plc->ChgCount++ % 10);
      pp = ini_ProcInsert(sts, cp, idstr, p_name, 1, 1, cp->plcfile[i].name,
          cPrio_plc_init, plc->StartWithDebug, 0, "", plc);
      pp->flags.b.plc = 1;
      cp->plc = pp;
      pp->proc.flags.b.user = 1;
      pp->proc.flags.b.k_mode = 1;
      pp->proc.k_size = 30;
      cp->plc_sigmask |= ini_mEvent_plc1 << plc_idx;
      plc_idx++;
    }
  }

  for (*sts = gdh_GetClassList(pwr_eClass_Appl, &oid); ODD(*sts);
       *sts = gdh_GetNextObject(oid, &oid)) {
    pwr_tObjName name;

    gdh_ObjidToName(oid, name, sizeof(name), cdh_mName_object);

    if (ODD(*sts = gdh_ObjidToPointer(oid, (pwr_tAddress*)&ap))) {
      pp = ini_ProcInsert(sts, cp, name, ap->ProgramName, ap->Load, ap->Run,
          ap->FileName, ap->JobPriority, ap->StartWithDebug, 0, ap->Arg, ap);
      pp->proc.flags.b.user = 1;
    }
  }

  f = ini_OpenFile(sts, cp, &cp->applfile);
  if (f != NULL) {
    if (cp->flags.b.verbose)
      errh_LogInfo(
          &cp->log, "Reading Application file %s\n", cp->applfile.name);
    for (;;) {
      char* nl;

      s = fgets(buffer, sizeof(buffer) - 1, f);
      if (s == NULL)
        break;
      nl = strchr(s, '\n');
      if (nl != NULL)
        *nl = '\0';

      if (cp->flags.b.verbose)
        errh_LogInfo(&cp->log, "   %s", buffer);
      if (buffer[0] == '#')
        continue;

      do {
        int i_load = -1;
        int i_run = -1;
        int i_debug = -1;
        int i_prio = -1;
        char* id = NULL;
        char* name = NULL;
        char* load = NULL;
        char* run = NULL;
        char* file = NULL;
        char* prio = NULL;
        char* debug = NULL;
        char* arg = NULL;

        id = strtok(s, ",");
        if (id == NULL)
          break;
        name = strtok(NULL, ",");
        if (name == NULL)
          break;
        load = strtok(NULL, ",");
        if (load == NULL)
          break;
        run = strtok(NULL, ",");
        if (run == NULL)
          break;
        file = strtok(NULL, ",");
        if (file == NULL)
          break;
        prio = strtok(NULL, ",");
        if (prio == NULL)
          break;
        debug = strtok(NULL, ",");
        if (debug == NULL)
          break;
        arg = strtok(NULL, ",");
        if (arg == NULL)
          break;

        while (isspace(*id))
          id++;
        while (isspace(*name))
          name++;
        while (isspace(*load))
          load++;
        while (isspace(*run))
          run++;
        while (isspace(*file))
          file++;
        while (isspace(*prio))
          prio++;
        while (isspace(*debug))
          debug++;
        while (isspace(*arg))
          arg++;

        if (id[0] == '\0')
          break;
        if (strstr(load, "no"))
          i_load = 0;
        else if (strstr(load, "load"))
          i_load = 1;

        if (strstr(run, "no"))
          i_run = 0;
        else if (strstr(run, "run"))
          i_run = 1;

        if (strstr(debug, "no"))
          i_debug = 0;
        else if (strstr(debug, "debug"))
          i_debug = 1;

        if (strcspn(prio, "0123456789") > 0)
          i_prio = -1;
        else
          i_prio = atoi(prio);

        pp = ini_ProcInsert(
            sts, cp, id, name, i_load, i_run, file, i_prio, i_debug, 0, arg, 0);
        if (!pp->proc.flags.b.system && !pp->proc.flags.b.base)
          pp->proc.flags.b.user = 1;
      } while (0);
    }
    fclose(f);
  }
}
