/*
 * ProviewR   Open Source Process Control.
 * Copyright (C) 2005-2021 SSAB EMEA AB.
 *
 * This file is part of ProviewR.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProviewR. If not, see <http://www.gnu.org/licenses/>
 *
 * Linking ProviewR statically or dynamically with other modules is
 * making a combined work based on ProviewR. Thus, the terms and
 * conditions of the GNU General Public License cover the whole
 * combination.
 *
 * In addition, as a special exception, the copyright holders of
 * ProviewR give you permission to, from the build function in the
 * ProviewR Configurator, combine ProviewR with modules generated by the
 * ProviewR PLC Editor to a PLC program, regardless of the license
 * terms of these modules. You may copy and distribute the resulting
 * combined work under the terms of your choice, provided that every
 * copy of the combined work is accompanied by a complete copy of
 * the source code of ProviewR (the version used to produce the
 * combined work), being distributed under the terms of the GNU
 * General Public License plus this exception.
 */

/* rt_rtt_dir.c
   This module contains routines for handling files and directories in rtt. */

/*_Include files_________________________________________________________*/

#include <dirent.h>
#include <stdlib.h>
#include <unistd.h>

#include "co_string.h"

#include "rt_rtt.h"
#include "rt_rtt_dir.h"
#include "rt_rtt_msg.h"

/*************************************************************************
*
* Name:		rtt_search_file
*
* Typ		int
*
* Typ		Parameter	IOGF	Beskrivning
*
* Beskrivning:
*		Söker efter en fil.
*		Filnamnet kan innehålla wildcard.
*		Vid sökning av flera filer mha wildcard anropas
*		rutinen första gången med new=1 och sedan med new=0.
*		Två sökningar med wildcard kan ej pågå parallellt efter
*		som sökvillkor lagras i interna variabler.
*
* Parametrar
*	file_name	*char	I  Namn på fil, kan innehålla wildcard.
*	found_file	*char	O  Hittad fil.
*	new		int	I  1 vid ej wildcard sökning och vid första
*				   wildcardsökningsanropet. 0 vid sökning
*				   efter fler filer med samma wildcard.
*
**************************************************************************/

int rtt_search_file(char* name, char* found_file, int new)
{
  static DIR* directory;
  static char pattern[80];
  char dev[2], dir[200], dir2[200], file[80], type[80];
  char cwd[200];
  int version;
  int found;
  int wildcard;
  struct dirent* dir_entry;

  if (new == RTT_DIR_SEARCH_INIT) {
    rtt_parse_filename(name, dev, dir, file, type, &version);
    rtt_replace_env(dir, dir2);
    if (strchr(dir2, '/') == 0) {
      /* Add cwd to the path */
      if (getcwd(cwd, sizeof(cwd)) == NULL)
        return RTT__NOFILE;
      strcpy(dir, cwd);
      strcat(dir, dir2);
    } else
      strcpy(dir, dir2);

    directory = opendir(dir);
    if (directory == NULL)
      return RTT__NOFILE;

    strcpy(pattern, file);
    strcat(pattern, type);
  }

  if (new == RTT_DIR_SEARCH_INIT || new == RTT_DIR_SEARCH_NEXT) {
    if (strchr(pattern, '*') != 0)
      wildcard = 1;
    else
      wildcard = 0;

    found = 0;
    while ((dir_entry = readdir(directory)) != NULL) {
      if (dir_entry->d_name[0] == '.')
        continue;

      if (wildcard) {
        if (rtt_wildcard(pattern, dir_entry->d_name) == 0) {
          strcpy(found_file, dir_entry->d_name);
          found = 1;
        }
      } else {
        if (streq(pattern, dir_entry->d_name)) {
          strcpy(found_file, dir_entry->d_name);
          found = 1;
        }
      }
      if (found)
        break;
    }
    if (!found)
      return RTT__NOFILE;
    else
      return RTT__SUCCESS;
  }

  if (new == RTT_DIR_SEARCH_END)
    closedir(directory);

  return RTT__SUCCESS;
}

/*************************************************************************
*
* Name:		rtt_parse_filename
*
* Typ		int
*
* Typ		Parameter	IOGF	Beskrivning
*
* Beskrivning:
*	Delar upp ett filnamn i device, directory, namn, typ och version.
*
* Parameterar
*	filenam		*char	I  Filnamn som ska delas.
*	dev		*char	O  device.
*	dir		*char	O  directory.
*	file		*char	O  filnamn.
*	type		*char	O  typ.
*	version		*int	O  version.
*
**************************************************************************/

int rtt_parse_filename(
    char* filename, char* dev, char* dir, char* file, char* type, int* version)
{
  char* s;
  char ldev[200];
  char ldir[200];
  char lfile[200];
  char ltype[80];

  if ((s = strstr(filename, "::")))
    s += 2;
  else
    s = filename;
  strcpy(ldev, "");
  strcpy(ldir, s);

  /* Directory */
  if ((s = strrchr(ldir, '/')))
    s++;
  else
    s = ldir;
  strcpy(lfile, s);
  *s = 0;

  /* File */
  if ((s = strchr(lfile, '.')) == 0)
    s = lfile;
  strcpy(ltype, s);
  *s = 0;

  /* Type */
  if ((s = strchr(ltype + 1, '.')) != 0)
    *s = 0;
  if ((s = strchr(ltype + 1, ';')) != 0)
    *s = 0;

  *version = 0;

  strcpy(dev, ldev);
  strcpy(dir, ldir);
  strcpy(file, lfile);
  strcpy(type, ltype);
  return 1;
}
