/*
 * ProviewR   Open Source Process Control.
 * Copyright (C) 2005-2021 SSAB EMEA AB.
 *
 * This file is part of ProviewR.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProviewR. If not, see <http://www.gnu.org/licenses/>
 *
 * Linking ProviewR statically or dynamically with other modules is
 * making a combined work based on ProviewR. Thus, the terms and
 * conditions of the GNU General Public License cover the whole
 * combination.
 *
 * In addition, as a special exception, the copyright holders of
 * ProviewR give you permission to, from the build function in the
 * ProviewR Configurator, combine ProviewR with modules generated by the
 * ProviewR PLC Editor to a PLC program, regardless of the license
 * terms of these modules. You may copy and distribute the resulting
 * combined work under the terms of your choice, provided that every
 * copy of the combined work is accompanied by a complete copy of
 * the source code of ProviewR (the version used to produce the
 * combined work), being distributed under the terms of the GNU
 * General Public License plus this exception.
 */

#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define streq(a,b) (strcmp((a),(b)) == 0)
#define str_StartsWith(str, prefix) (strncmp(str, prefix, strlen(prefix)) == 0)

char prefix[][10] = { "gdhr", "gdh", "cdhr", "cdh", "pwrb", "pwrt", "pwr", "rt",
  "co", "jop", "ge", "qcomr", "qcom", "cli" };

int main(int argc, char* argv[])
{
  char filename[256];
  char destination[256];
  char *s, *t;
  int i;
  int sts;

  if (argc > 3 && streq(argv[1], "-d")) {
    strncpy(destination, argv[2], sizeof(destination));

    /* Cut last to segments in directory (package name) */
    if ((s = strrchr(destination, '/'))) {
      *s = 0;
      if ((s = strrchr(destination, '/'))) {
        *s = 0;
        if ((s = strrchr(destination, '/')))
          *s = 0;
      }
    }
    strncpy(filename, argv[3], sizeof(filename));
  } else if (argc > 1) {
    strncpy(filename, argv[1], sizeof(filename));
    strncpy(destination, "", sizeof(destination));
  } else {
    printf("Usage:\n");
    printf("	-d	target directory\n");
    printf("	arg	filename\n");
    exit(0);
  }

  if ((s = strrchr(filename, '/')))
    s++;
  else
    s = filename;
  /* Special cases */
  if (streq(s, "cdhrclassid.java"))
    strcpy(s, "CdhrClassId.java");
  else if (streq(s, "gdhrrefobjectinfo.java"))
    strcpy(s, "GdhrRefObjectInfo.java");
  else if (streq(s, "pwrtrefid.java"))
    strcpy(s, "PwrtRefId.java");
  else if (streq(s, "qcomrcreateq.java"))
    strcpy(s, "QcomrCreateQ.java");
  else if (streq(s, "gecformat.java"))
    strcpy(s, "GeCFormat.java");
  else if (streq(s, "jopspiderframe.java"))
    strcpy(s, "JopSpiderFrame.java");
  else if (streq(s, "gecoloreditor.java"))
    strcpy(s, "GeColorEditor.java");
  else if (streq(s, "gecolorbrightnesseditor.java"))
    strcpy(s, "GeColorBrightnessEditor.java");
  else if (streq(s, "gecolortoneeditor.java"))
    strcpy(s, "GeColorToneEditor.java");
  else if (streq(s, "gecolorintensityeditor.java"))
    strcpy(s, "GeColorIntensityEditor.java");
  else if (streq(s, "gecolorshifteditor.java"))
    strcpy(s, "GeColorShiftEditor.java");
  else if (streq(s, "clickactioneditor.java"))
    strcpy(s, "ClickActionEditor.java");
  else if (streq(s, "jopconfirmdialog.java"))
    strcpy(s, "JopConfirmDialog.java");
  else if (streq(s, "getextfield.java"))
    strcpy(s, "GeTextField.java");
  else if (streq(s, "joptextfield.java"))
    strcpy(s, "JopTextField.java");
  else if (streq(s, "joptextfieldbeaninfo.java"))
    strcpy(s, "JopTextFieldBeanInfo.java");
  else if (streq(s, "joploginapplet.java"))
    strcpy(s, "JopLoginApplet.java");
  else if (streq(s, "joploginframe.java"))
    strcpy(s, "JopLoginFrame.java");
  else {
    for (i = 0; i < sizeof(prefix) / sizeof(prefix[0]); i++) {
      if (str_StartsWith(s, prefix[i])) {
        *s = _toupper(*s);
        if (strlen(s) > strlen(prefix[i]))
          *(s + strlen(prefix[i])) = _toupper(*(s + strlen(prefix[i])));
        break;
      }
    }
  }
  if ((s = strrchr(filename, '/')))
    s++;
  else
    s = filename;
  if ((t = strstr(s, "beaninfo.java")))
    strcpy(t, "BeanInfo.java");

  char cmd[9 + sizeof(destination) + 1 + sizeof(filename) + 1];
  if (streq(destination, ""))
    snprintf(cmd, sizeof(cmd), "javac %s", filename);
  else
    snprintf(cmd, sizeof(cmd), "javac -d %s %s", destination, filename);

  printf("Cmd: %s\n", cmd);
  sts = system(cmd);
  exit(sts);
}
