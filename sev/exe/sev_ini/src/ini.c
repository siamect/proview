/*
 * ProviewR   Open Source Process Control.
 * Copyright (C) 2005-2021 SSAB EMEA AB.
 *
 * This file is part of ProviewR.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of
 * the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with ProviewR. If not, see <http://www.gnu.org/licenses/>
 *
 * Linking ProviewR statically or dynamically with other modules is
 * making a combined work based on ProviewR. Thus, the terms and
 * conditions of the GNU General Public License cover the whole
 * combination.
 *
 * In addition, as a special exception, the copyright holders of
 * ProviewR give you permission to, from the build function in the
 * ProviewR Configurator, combine ProviewR with modules generated by the
 * ProviewR PLC Editor to a PLC program, regardless of the license
 * terms of these modules. You may copy and distribute the resulting
 * combined work under the terms of your choice, provided that every
 * copy of the combined work is accompanied by a complete copy of
 * the source code of ProviewR (the version used to produce the
 * combined work), being distributed under the terms of the GNU
 * General Public License plus this exception.
 */

#include <ctype.h>

#include <sys/wait.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

#include "co_dbs.h"
#include "co_syi.h"
#include "rt_gdh.h"
#include "rt_ini_msg.h"

#include "ini.h"

#define cPrio_base 0
#define cPrio_qmon (cPrio_base + 19)
#define cPrio_sev_server (cPrio_base + 6)

void ini_ProcTable(pwr_tStatus* status, ini_sContext* cp)
{
  FILE* f;
  ini_sProc* pp;
  char* s;
  char buffer[256];
  char sev_server_args[20] = "-n";

  pwr_dStatus(sts, status, INI__SUCCESS);

  pp = ini_ProcInsert(sts, cp, "pwr_qmon", "pwr_qmon_%d", 0, 1, "rt_qmon",
      cPrio_qmon, 0, 0, "-n", 0);
  pp->flags.b.qmon = 1;
  pp->proc.flags.b.system = 1;

  if (cp->flags.b.rootvolume)
    strcpy(sev_server_args, "");
  pp = ini_ProcInsert(sts, cp, "pwr_sev_server", "pwr_sev_server_%d", 0, 1,
      "sev_server", cPrio_sev_server, 0, 0, sev_server_args, 0);
  pp->proc.flags.b.system = 1;

  f = ini_OpenFile(sts, cp, &cp->applfile);
  if (f != NULL) {
    if (cp->flags.b.verbose)
      errh_LogInfo(
          &cp->log, "Reading Application file %s\n", cp->applfile.name);
    for (;;) {
      char* nl;

      s = fgets(buffer, sizeof(buffer) - 1, f);
      if (s == NULL)
        break;
      nl = strchr(s, '\n');
      if (nl != NULL)
        *nl = '\0';

      if (cp->flags.b.verbose)
        errh_LogInfo(&cp->log, "   %s", buffer);
      if (buffer[0] == '#')
        continue;

      do {
        int i_load = -1;
        int i_run = -1;
        int i_debug = -1;
        int i_prio = -1;
        char* id = NULL;
        char* name = NULL;
        char* load = NULL;
        char* run = NULL;
        char* file = NULL;
        char* prio = NULL;
        char* debug = NULL;
        char* arg = NULL;

        id = strtok(s, ",");
        if (id == NULL)
          break;
        name = strtok(NULL, ",");
        if (name == NULL)
          break;
        load = strtok(NULL, ",");
        if (load == NULL)
          break;
        run = strtok(NULL, ",");
        if (run == NULL)
          break;
        file = strtok(NULL, ",");
        if (file == NULL)
          break;
        prio = strtok(NULL, ",");
        if (prio == NULL)
          break;
        debug = strtok(NULL, ",");
        if (debug == NULL)
          break;
        arg = strtok(NULL, ",");
        if (arg == NULL)
          break;

        while (isspace(*id))
          id++;
        while (isspace(*name))
          name++;
        while (isspace(*load))
          load++;
        while (isspace(*run))
          run++;
        while (isspace(*file))
          file++;
        while (isspace(*prio))
          prio++;
        while (isspace(*debug))
          debug++;
        while (isspace(*arg))
          arg++;

        if (id[0] == '\0')
          break;
        if (strstr(load, "no"))
          i_load = 0;
        else if (strstr(load, "load"))
          i_load = 1;

        if (strstr(run, "no"))
          i_run = 0;
        else if (strstr(run, "run"))
          i_run = 1;

        if (strstr(debug, "no"))
          i_debug = 0;
        else if (strstr(debug, "debug"))
          i_debug = 1;

        if (strcspn(prio, "0123456789") > 0)
          i_prio = -1;
        else
          i_prio = atoi(prio);

        pp = ini_ProcInsert(
            sts, cp, id, name, i_load, i_run, file, i_prio, i_debug, 0, arg, 0);
        if (!pp->proc.flags.b.system && !pp->proc.flags.b.base)
          pp->proc.flags.b.user = 1;
      } while (0);
    }
    fclose(f);
  }
}
